<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        :root {
            --primary: #00AEEF;
            --secondary: #425563;
            --accent-green: #A7C796;
            --accent-blue: #B8DFEC;
            --white: #ffffff;
            --light-gray: #f5f5f5;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
            color: var(--secondary);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent-green) 100%);
            color: var(--white);
            padding: 30px;
            text-align: center;
        }
        header h1 {
            font-size: 2.5em;
            font-weight: 600;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        header p {
            font-size: 1.1em;
            opacity: 0.95;
        }
        .content {
            padding: 40px;
        }
        .file-upload-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .file-upload-box {
            background: var(--accent-blue);
            border: 3px dashed var(--primary);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        .file-upload-box:hover {
            background: rgba(184, 223, 236, 0.6);
            border-color: var(--accent-green);
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0, 174, 239, 0.3);
        }
        .file-upload-box.dragover {
            background: rgba(167, 199, 150, 0.3);
            border-color: var(--accent-green);
            transform: scale(1.02);
        }
        .file-upload-box.loaded {
            background: rgba(167, 199, 150, 0.3);
            border-color: var(--accent-green);
            border-style: solid;
        }
        .file-upload-box input[type="file"] {
            display: none;
        }
        .upload-icon {
            font-size: 3em;
            color: var(--primary);
            margin-bottom: 15px;
        }
        .file-upload-box.loaded .upload-icon {
            color: var(--accent-green);
        }
        .file-upload-box h3 {
            color: var(--secondary);
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        .file-upload-box p {
            color: var(--secondary);
            font-size: 0.9em;
            opacity: 0.8;
        }
        .file-name {
            margin-top: 10px;
            font-weight: 600;
            color: var(--accent-green);
            font-size: 0.9em;
            word-break: break-word;
        }
        .optional-badge {
            display: inline-block;
            background: var(--accent-green);
            color: var(--white);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            margin-left: 5px;
            font-weight: 600;
        }
        .buttons-section {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        button {
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 15px 35px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 174, 239, 0.3);
        }
        button:hover {
            background: #0099d6;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 174, 239, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        button.secondary {
            background: var(--accent-green);
        }
        button.secondary:hover {
            background: #95b585;
        }
        button.reset {
            background: var(--secondary);
        }
        button.reset:hover {
            background: #354251;
        }
        .stats {
            background: var(--light-gray);
            border-left: 4px solid var(--primary);
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .stats h3 {
            color: var(--primary);
            margin-bottom: 10px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-item {
            background: var(--white);
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid var(--accent-blue);
        }
        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: var(--primary);
        }
        .stat-label {
            font-size: 0.9em;
            color: var(--secondary);
            margin-top: 5px;
        }
        .table-container {
            overflow-x: auto;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
        }
        thead {
            background: var(--primary);
            color: var(--white);
            position: sticky;
            top: 0;
        }
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.95em;
            border-bottom: 2px solid var(--secondary);
        }
        tbody tr {
            transition: background 0.2s ease;
        }
        tbody tr:nth-child(even) {
            background: var(--accent-blue);
        }
        tbody tr:hover {
            background: rgba(0, 174, 239, 0.1);
        }
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9em;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--primary);
        }
        .loading-spinner {
            border: 4px solid var(--accent-blue);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .message {
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 8px;
            font-weight: 500;
        }
        .message.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }
        .message.success {
            background: rgba(167, 199, 150, 0.3);
            color: #2e7d32;
            border-left: 4px solid var(--accent-green);
        }
        .message.info {
            background: var(--accent-blue);
            color: var(--secondary);
            border-left: 4px solid var(--primary);
        }
        .hidden {
            display: none;
        }
        @media print {
            body {
                background: white;
                padding: 0;
            }
            .container {
                box-shadow: none;
                border-radius: 0;
            }
            header,
            .file-upload-section,
            .buttons-section,
            .stats,
            button {
                display: none !important;
            }
            .content {
                padding: 20px;
            }
            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 2px solid var(--secondary);
            }
            .print-header h2 {
                font-size: 1.8em;
                color: var(--secondary);
            }
            .table-container {
                box-shadow: none;
            }
            table {
                font-size: 10pt;
            }
            th, td {
                padding: 8px;
            }
            tbody tr {
                page-break-inside: avoid;
            }
            thead {
                display: table-header-group;
            }
            @page {
                size: landscape;
                margin: 1cm;
            }
        }
        .print-header {
            display: none;
        }
        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            header h1 {
                font-size: 1.8em;
            }
            .file-upload-section {
                grid-template-columns: 1fr;
            }
            .buttons-section {
                flex-direction: column;
            }
            button {
                width: 100%;
            }
            table {
                font-size: 0.8em;
            }
            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöö –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</h1>
            <p>–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–æ–≤ –∏ —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤</p>
        </header>
 
        <div class="content">
            <div class="file-upload-section">
                <div class="file-upload-box" id="file1Box">
                    <input type="file" id="file1" accept=".xlsx,.xls">
                    <div class="upload-icon">üìã</div>
                    <h3>–û—Ç—á—ë—Ç –ø–æ –û–° –Ω–∞ –æ—Ç–≥—Ä—É–∑–∫—É</h3>
                    <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ –∑–∞–∫–∞–∑–∞–º</p>
                    <div class="file-name" id="file1Name"></div>
                </div>
 
                <div class="file-upload-box" id="file2Box">
                    <input type="file" id="file2" accept=".xlsx,.xls">
                    <div class="upload-icon">üìÖ</div>
                    <h3>1–° —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ú–°–ö</h3>
                    <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —Å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º –æ—Ç–≥—Ä—É–∑–æ–∫</p>
                    <div class="file-name" id="file2Name"></div>
                </div>
 
                <div class="file-upload-box" id="file3Box">
                    <input type="file" id="file3" accept=".xlsx,.xls">
                    <div class="upload-icon">üì¶</div>
                    <h3>POSM <span class="optional-badge">–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ</span></h3>
                    <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</p>
                    <div class="file-name" id="file3Name"></div>
                </div>
            </div>
 
            <div class="buttons-section">
                <button id="processBtn" disabled>–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                <button id="downloadBtn" class="secondary" disabled>üì• –°–∫–∞—á–∞—Ç—å Excel</button>
                <button id="printBtn" class="secondary" disabled>üñ®Ô∏è –ü–µ—á–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã</button>
                <button id="resetBtn" class="reset">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>
            </div>
 
            <div id="messages"></div>
            
            <div id="statsSection" class="hidden stats">
                <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="statTotal">0</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statFiltered">0</div>
                        <div class="stat-label">–ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statTransports">0</div>
                        <div class="stat-label">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statBrands">0</div>
                        <div class="stat-label">–ë—Ä–µ–Ω–¥–æ–≤</div>
                    </div>
                </div>
            </div>
 
            <div class="print-header">
                <h2>–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</h2>
                <p id="printDate"></p>
            </div>
 
            <div id="previewSection" class="hidden">
                <h3 style="color: var(--primary); margin: 20px 0;">–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h3>
                <div class="table-container">
                    <table id="previewTable">
                        <thead>
                            <tr>
                                <th>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç/‚Ññ –∑–∞–∫–∞–∑–∞</th>
                                <th>‚Ññ –º–∞–≥–∞–∑–∏–Ω–∞</th>
                                <th>–ë—Ä–µ–Ω–¥/–¢–¶</th>
                                <th>–ú–µ—Å—Ç–æ</th>
                                <th>–ö–æ–ª-–≤–æ –∫–æ—Ä</th>
                                <th>–ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –ë—Ä–µ–Ω–¥–∞ –≤ –¢–°</th>
                                <th>–ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –≤–Ω—É—Ç—Ä–∏ –ë—Ä–µ–Ω–¥–∞</th>
                                <th>–ö–æ–º–º–µ–Ω—Ç.</th>
                            </tr>
                        </thead>
                        <tbody id="previewBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
 
    <script>
        let file1Data = null;
        let file2Data = null;
        let file3Data = null;
        let processedData = null;
        const MOSCOW_BRANDS = ['VILET', 'DUB', 'ECRU', 'MAAG'];
        
        const BRAND_FILTERS = [
            { keywords: ['VILET', '–í–ò–õ–ï–¢'], priority: 1 },
            { keywords: ['DUB', '–î–ê–ë'], priority: 2 },
            { keywords: ['ECRU', '–≠–ö–†–Æ'], priority: 3 },
            { keywords: ['MAAG', '–ú–ê–ê–ì'], priority: 4 }
        ];
        function showMessage(text, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            messagesDiv.appendChild(message);
            setTimeout(() => message.remove(), 5000);
        }
        function setupFileUpload(boxId, inputId, fileNameId, fileNumber) {
            const box = document.getElementById(boxId);
            const input = document.getElementById(inputId);
            const fileName = document.getElementById(fileNameId);
            box.addEventListener('click', () => input.click());
            box.addEventListener('dragover', (e) => {
                e.preventDefault();
                box.classList.add('dragover');
            });
            box.addEventListener('dragleave', () => {
                box.classList.remove('dragover');
            });
            box.addEventListener('drop', (e) => {
                e.preventDefault();
                box.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    input.files = files;
                    handleFileUpload(files[0], fileNumber, fileName, box);
                }
            });
            input.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0], fileNumber, fileName, box);
                }
            });
        }
        function handleFileUpload(file, fileNumber, fileNameElement, box) {
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    if (fileNumber === 1) {
                        file1Data = jsonData;
                    } else if (fileNumber === 2) {
                        file2Data = jsonData;
                    } else if (fileNumber === 3) {
                        file3Data = jsonData;
                    }
                    fileNameElement.textContent = `‚úì ${file.name}`;
                    box.classList.add('loaded');
                    showMessage(`–§–∞–π–ª "${file.name}" —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω`, 'success');
                    checkFilesReady();
                } catch (error) {
                    showMessage(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ "${file.name}": ${error.message}`, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        function checkFilesReady() {
            const processBtn = document.getElementById('processBtn');
            if (file1Data && file2Data) {
                processBtn.disabled = false;
            }
        }
        function normalizeColumnName(name) {
            return String(name).trim().toLowerCase();
        }
        function findColumn(row, possibleNames) {
            const normalizedRow = {};
            Object.keys(row).forEach(key => {
                normalizedRow[normalizeColumnName(key)] = row[key];
            });
            for (const name of possibleNames) {
                const normalized = normalizeColumnName(name);
                if (normalizedRow[normalized] !== undefined) {
                    return row[Object.keys(row).find(k => normalizeColumnName(k) === normalized)];
                }
            }
            return null;
        }
        function getColumnValue(row, ...possibleNames) {
            return findColumn(row, possibleNames);
        }
        function filterFile1Data(data) {
            return data.filter(row => {
                const orderType = getColumnValue(row, '–¢–∏–ø –∑–∞–∫–∞–∑–∞', '—Ç–∏–ø –∑–∞–∫–∞–∑–∞');
                const storeNumber = getColumnValue(row, '–ù–æ–º–µ—Ä –º–∞–≥–∞–∑–∏–Ω–∞', '–Ω–æ–º–µ—Ä –º–∞–≥–∞–∑–∏–Ω–∞');
                if (orderType && String(orderType).toUpperCase().includes('MOP')) {
                    return false;
                }
                if (orderType && String(orderType).toUpperCase().includes('POSM')) {
                    return false;
                }
                if (storeNumber && /[–∞-—è–ê-–Øa-zA-Z]/.test(String(storeNumber))) {
                    return false;
                }
                return true;
            });
        }
        function getDayOfWeekFromDate(dateValue) {
            if (!dateValue) return null;
            
            let date;
            if (dateValue instanceof Date) {
                date = dateValue;
            } else if (typeof dateValue === 'number') {
                date = new Date((dateValue - 25569) * 86400 * 1000);
            } else if (typeof dateValue === 'string') {
                date = new Date(dateValue);
            } else {
                return null;
            }
            
            if (isNaN(date.getTime())) return null;
            
            const dayOfWeek = date.getDay();
            return dayOfWeek === 0 ? 7 : dayOfWeek;
        }
        function createStoreKey(storeNumber, dayOfWeek) {
            return `${storeNumber}_${dayOfWeek}`;
        }
        function getBrandSequence(brandName) {
            const brandStr = String(brandName || '').toUpperCase();
            
            if (brandStr.includes('–í–ò–õ–ï–¢') || brandStr.includes('VILET')) {
                return 1;
            }
            if (brandStr.includes('–≠–ö–†–Æ') || brandStr.includes('ECRU')) {
                return 2;
            }
            if (brandStr.includes('–î–ê–ë') || brandStr.includes('DUB')) {
                return 3;
            }
            if (brandStr.includes('–ú–ê–ê–ì') || brandStr.includes('MAAG')) {
                return 4;
            }
            
            return 999;
        }
        function getInternalSequence(flightNumber, file3Data) {
            if (!file3Data) {
                return undefined;
            }
            const posmRecord = file3Data.find(row => {
                const raceNumber = getColumnValue(row, '–†–µ–π—Å', '—Ä–µ–π—Å', '–¢—Ä–∞–∫', '—Ç—Ä–∞–∫');
                return String(raceNumber) === String(flightNumber);
            });
            if (!posmRecord) {
                return undefined;
            }
            const sequence = getColumnValue(posmRecord, '–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å', '–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å');
            if (sequence && !isNaN(parseInt(sequence))) {
                return parseInt(sequence);
            }
            const name = getColumnValue(posmRecord, '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', '–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ');
            if (name) {
                const nameStr = String(name).toUpperCase();
                
                if (nameStr.includes('POSM') || nameStr.includes('–ü–û–°–ú')) {
                    return 6;
                }
                if (nameStr.includes('–¢–†–ê–ù–°–§–ï–†') || nameStr.includes('TRANSFER')) {
                    return 5;
                }
                return 7;
            }
            return undefined;
        }
        function getComment(orderNumber, file3Data) {
            if (!file3Data) return '';
            const posmRecord = file3Data.find(row => {
                const osNumber = getColumnValue(row, '–ù–æ–º–µ—Ä –û–°', '–Ω–æ–º–µ—Ä –æ—Å');
                return String(osNumber) === String(orderNumber);
            });
            if (posmRecord) {
                const comment = getColumnValue(posmRecord, '–ö–æ–º–º–µ–Ω—Ç.', '–∫–æ–º–º–µ–Ω—Ç', '–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π');
                return comment || '';
            }
            return '';
        }
        function getInternalSequenceText(sequence) {
            if (sequence === undefined || sequence === 1) {
                return '–¢–µ–∫—Å—Ç–∏–ª—å';
            }
            if (sequence === 2 || sequence === 5) {
                return '–¢—Ä–∞–Ω—Å—Ñ–µ—Ä';
            }
            if (sequence === 3 || sequence === 6) {
                return 'POSM';
            }
            if (sequence === 4 || sequence === 7) {
                return '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ';
            }
            return String(sequence);
        }
        function getBrandFilterPriority(brandName) {
            const brandStr = String(brandName || '').toUpperCase();
            
            for (const filter of BRAND_FILTERS) {
                for (const keyword of filter.keywords) {
                    if (brandStr.includes(keyword.toUpperCase())) {
                        return filter.priority;
                    }
                }
            }
            
            return 999;
        }
        function processData() {
            if (!file1Data || !file2Data) {
                showMessage('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã', 'error');
                return;
            }
            try {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'loading';
                loadingDiv.innerHTML = '<div class="loading-spinner"></div><p>–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>';
                document.querySelector('.content').appendChild(loadingDiv);
                setTimeout(() => {
                    try {
                        const filteredData = filterFile1Data(file1Data);
                        const palletMap = new Map();
                        
                        filteredData.forEach(row => {
                            const orderNumber = getColumnValue(row, '–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞', '–Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞');
                            const storeNumber = getColumnValue(row, '–ù–æ–º–µ—Ä –º–∞–≥–∞–∑–∏–Ω–∞', '–Ω–æ–º–µ—Ä –º–∞–≥–∞–∑–∏–Ω–∞');
                            const direction = getColumnValue(row, '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', '–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ');
                            const flightNumber = getColumnValue(row, '–ù–æ–º–µ—Ä —Ä–µ–π—Å–∞', '–Ω–æ–º–µ—Ä —Ä–µ–π—Å–∞');
                            const place = getColumnValue(row, '–ú–µ—Å—Ç–æ', '–º–µ—Å—Ç–æ');
                            const pallet = getColumnValue(row, '–ü–∞–ª–ª–µ—Ç', '–ø–∞–ª–ª–µ—Ç');
                            const box = getColumnValue(row, '–ö–æ—Ä–æ–±', '–∫–æ—Ä–æ–±');
                            const dispatchDate = getColumnValue(row, '–î–∞—Ç–∞ –æ—Ç–≥—Ä—É–∑–∫–∏', '–¥–∞—Ç–∞ –æ—Ç–≥—Ä—É–∑–∫–∏');
                            let palletKey;
                            if (!pallet || String(pallet).trim() === '') {
                                if (place && String(place).trim() !== '') {
                                    palletKey = `PLACE_${place}_${orderNumber}`;
                                } else {
                                    palletKey = `EMPTY_${orderNumber}_${Math.random()}`;
                                }
                            } else {
                                palletKey = `PALLET_${pallet}`;
                            }
                            
                            if (!palletMap.has(palletKey)) {
                                palletMap.set(palletKey, {
                                    row: row,
                                    boxes: new Set(),
                                    orderNumber: orderNumber,
                                    storeNumber: storeNumber,
                                    direction: direction,
                                    flightNumber: flightNumber,
                                    place: place,
                                    pallet: pallet,
                                    dispatchDate: dispatchDate
                                });
                            }
                            
                            if (box) {
                                palletMap.get(palletKey).boxes.add(String(box));
                            }
                        });
                        const result = Array.from(palletMap.values()).map(palletData => {
                            const orderNumber = palletData.orderNumber;
                            const storeNumber = palletData.storeNumber;
                            const direction = palletData.direction;
                            const flightNumber = palletData.flightNumber;
                            const place = palletData.place;
                            const boxesCount = palletData.boxes.size;
                            const dispatchDate = palletData.dispatchDate;
                            const brandSequence = getBrandSequence(direction);
                            const comment = getComment(orderNumber, file3Data);
                            const brandFilterPriority = getBrandFilterPriority(direction);
                            return {
                                transport: flightNumber || '',
                                storeNumber: storeNumber || '',
                                brand: direction || '',
                                place: place || '',
                                quantity: boxesCount,
                                brandSequence: brandSequence,
                                internalSequence: 1,
                                internalSequenceText: '–¢–µ–∫—Å—Ç–∏–ª—å',
                                comment: comment,
                                brandFilterPriority: brandFilterPriority,
                                source: 'REPORT'
                            };
                        });
                        if (file3Data && file3Data.length > 0) {
                            file3Data.forEach(posmRow => {
                                const raceNumber = getColumnValue(posmRow, '–†–µ–π—Å', '—Ä–µ–π—Å', '–¢—Ä–∞–∫', '—Ç—Ä–∞–∫');
                                const storeNumber = getColumnValue(posmRow, '–º–∞–≥–∞–∑–∏–Ω', '–ú–∞–≥–∞–∑–∏–Ω', 'STORE N', 'store n');
                                const brandName = getColumnValue(posmRow, '–ë—Ä–µ–Ω–¥', '–±—Ä–µ–Ω–¥', 'BRAND', 'brand');
                                const regionDelivery = getColumnValue(posmRow, '–†–µ–≥–∏–æ–Ω –¥–æ—Å—Ç–∞–≤–∫–∏', '—Ä–µ–≥–∏–æ–Ω –¥–æ—Å—Ç–∞–≤–∫–∏');
                                const sequence = getColumnValue(posmRow, '–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å', '–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å');
                                const name = getColumnValue(posmRow, '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', '–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ');
                                const size = getColumnValue(posmRow, '–†–∞–∑–º–µ—Ä', '—Ä–∞–∑–º–µ—Ä');
                                const weight = getColumnValue(posmRow, '–í–µ—Å', '–≤–µ—Å');
                                if (!raceNumber) return;
                                let internalSequence = 4;
                                if (sequence && !isNaN(parseInt(sequence))) {
                                    internalSequence = parseInt(sequence);
                                } else if (name) {
                                    const nameStr = String(name).toUpperCase();
                                    if (nameStr.includes('POSM') || nameStr.includes('–ü–û–°–ú')) {
                                        internalSequence = 3;
                                    } else if (nameStr.includes('–¢–†–ê–ù–°–§–ï–†') || nameStr.includes('TRANSFER')) {
                                        internalSequence = 2;
                                    }
                                }
                                let commentParts = [];
                                if (name) commentParts.push(String(name));
                                if (size) commentParts.push(String(size));
                                if (weight) commentParts.push(String(weight));
                                const posmComment = commentParts.join(' ');
                                const brandSequence = getBrandSequence(brandName || regionDelivery);
                                const brandFilterPriority = getBrandFilterPriority(brandName || regionDelivery);
                                result.push({
                                    transport: raceNumber || '',
                                    storeNumber: storeNumber || '',
                                    brand: `${brandName || regionDelivery || ''} POSM`,
                                    place: '',
                                    quantity: 1,
                                    brandSequence: brandSequence,
                                    internalSequence: internalSequence,
                                    internalSequenceText: getInternalSequenceText(internalSequence),
                                    comment: posmComment,
                                    brandFilterPriority: brandFilterPriority,
                                    source: 'POSM'
                                });
                            });
                        }
                        result.sort((a, b) => {
                            // –£—Ä–æ–≤–µ–Ω—å 1: –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—É
                            if (a.transport !== b.transport) {
                                return String(a.transport).localeCompare(String(b.transport));
                            }
                            
                            // –£—Ä–æ–≤–µ–Ω—å 2: –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ë—Ä–µ–Ω–¥–∞ –≤ –¢–° (VILET=1, ECRU=2, DUB=3, MAAG=4)
                            const seqA = a.brandSequence ?? 999;
                            const seqB = b.brandSequence ?? 999;
                            if (seqA !== seqB) {
                                return seqA - seqB;
                            }
                            
                            // –£—Ä–æ–≤–µ–Ω—å 3: –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–Ω—É—Ç—Ä–∏ –ë—Ä–µ–Ω–¥–∞ (–¢–µ–∫—Å—Ç–∏–ª—å=1, –¢—Ä–∞–Ω—Å—Ñ–µ—Ä=5, POSM=6, –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ=7)
                            const internalA = a.internalSequence ?? 999;
                            const internalB = b.internalSequence ?? 999;
                            return internalA - internalB;
                        });
                        // –ü–µ—Ä–µ–Ω—É–º–µ—Ä–∞—Ü–∏—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –±—Ä–µ–Ω–¥–æ–≤ –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–≥–æ —Ä–µ–π—Å–∞
                        let currentTransport = null;
                        let brandSequenceMap = new Map();
                        let sequenceCounter = 0;
                        
                        result.forEach(row => {
                            if (row.transport !== currentTransport) {
                                currentTransport = row.transport;
                                brandSequenceMap = new Map();
                                sequenceCounter = 0;
                            }
                            
                            if (!brandSequenceMap.has(row.brandSequence)) {
                                sequenceCounter++;
                                brandSequenceMap.set(row.brandSequence, sequenceCounter);
                            }
                            
                            row.displayBrandSequence = brandSequenceMap.get(row.brandSequence);
                        });
                        processedData = result;
                        const transports = new Set(result.map(r => r.transport));
                        const brands = new Set(result.map(r => r.brand));
                        document.getElementById('statTotal').textContent = file1Data.length;
                        document.getElementById('statFiltered').textContent = filteredData.length;
                        document.getElementById('statTransports').textContent = transports.size;
                        document.getElementById('statBrands').textContent = brands.size;
                        document.getElementById('statsSection').classList.remove('hidden');
                        displayPreview(result);
                        document.getElementById('downloadBtn').disabled = false;
                        document.getElementById('printBtn').disabled = false;
                        loadingDiv.remove();
                        showMessage('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã!', 'success');
                    } catch (error) {
                        loadingDiv.remove();
                        showMessage(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, 'error');
                        console.error(error);
                    }
                }, 100);
            } catch (error) {
                showMessage(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }
        function displayPreview(data) {
            const tbody = document.getElementById('previewBody');
            tbody.innerHTML = '';
            const displayData = data.slice(0, 100);
            displayData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.transport}</td>
                    <td>${row.storeNumber}</td>
                    <td>${row.brand}</td>
                    <td>${row.place}</td>
                    <td>${row.quantity}</td>
                    <td>${row.displayBrandSequence}</td>
                    <td>${row.internalSequenceText}</td>
                    <td>${row.comment}</td>
                `;
                tbody.appendChild(tr);
            });
            if (data.length > 100) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="8" style="text-align: center; font-style: italic; color: var(--secondary);">
                    ... –∏ –µ—â–µ ${data.length - 100} –∑–∞–ø–∏—Å–µ–π (–±—É–¥—É—Ç –≤–∫–ª—é—á–µ–Ω—ã –≤ Excel —Ñ–∞–π–ª)
                </td>`;
                tbody.appendChild(tr);
            }
            document.getElementById('previewSection').classList.remove('hidden');
        }
        function downloadExcel() {
            if (!processedData || processedData.length === 0) {
                showMessage('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'error');
                return;
            }
            try {
                const exportData = processedData.map(row => ({
                    '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç/‚Ññ –∑–∞–∫–∞–∑–∞': row.transport,
                    '‚Ññ –º–∞–≥–∞–∑–∏–Ω–∞': row.storeNumber,
                    '–ë—Ä–µ–Ω–¥/–¢–¶': row.brand,
                    '–ú–µ—Å—Ç–æ': row.place,
                    '–ö–æ–ª-–≤–æ –∫–æ—Ä': row.quantity,
                    '–ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –ë—Ä–µ–Ω–¥–∞ –≤ –¢–°': row.displayBrandSequence,
                    '–ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –≤–Ω—É—Ç—Ä–∏ –ë—Ä–µ–Ω–¥–∞': row.internalSequenceText,
                    '–ö–æ–º–º–µ–Ω—Ç.': row.comment
                }));
                const ws = XLSX.utils.json_to_sheet(exportData);
                const colWidths = [
                    { wch: 20 },
                    { wch: 15 },
                    { wch: 25 },
                    { wch: 15 },
                    { wch: 12 },
                    { wch: 22 },
                    { wch: 22 },
                    { wch: 30 }
                ];
                ws['!cols'] = colWidths;
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è');
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                XLSX.writeFile(wb, `–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è_–∑–∞–≥—Ä—É–∑–∫–∏_${timestamp}.xlsx`);
                showMessage('Excel —Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω!', 'success');
            } catch (error) {
                showMessage(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Excel —Ñ–∞–π–ª–∞: ${error.message}`, 'error');
            }
        }
        function printTable() {
            const printDate = document.getElementById('printDate');
            printDate.textContent = `–î–∞—Ç–∞: ${new Date().toLocaleString('ru-RU')}`;
            window.print();
        }
        function resetAll() {
            file1Data = null;
            file2Data = null;
            file3Data = null;
            processedData = null;
            document.getElementById('file1').value = '';
            document.getElementById('file2').value = '';
            document.getElementById('file3').value = '';
            document.getElementById('file1Name').textContent = '';
            document.getElementById('file2Name').textContent = '';
            document.getElementById('file3Name').textContent = '';
            document.getElementById('file1Box').classList.remove('loaded');
            document.getElementById('file2Box').classList.remove('loaded');
            document.getElementById('file3Box').classList.remove('loaded');
            document.getElementById('processBtn').disabled = true;
            document.getElementById('downloadBtn').disabled = true;
            document.getElementById('printBtn').disabled = true;
            document.getElementById('statsSection').classList.add('hidden');
            document.getElementById('previewSection').classList.add('hidden');
            document.getElementById('messages').innerHTML = '';
            showMessage('–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã', 'info');
        }
        setupFileUpload('file1Box', 'file1', 'file1Name', 1);
        setupFileUpload('file2Box', 'file2', 'file2Name', 2);
        setupFileUpload('file3Box', 'file3', 'file3Name', 3);
        document.getElementById('processBtn').addEventListener('click', processData);
        document.getElementById('downloadBtn').addEventListener('click', downloadExcel);
        document.getElementById('printBtn').addEventListener('click', printTable);
        document.getElementById('resetBtn').addEventListener('click', resetAll);
        showMessage('–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã', 'info');
    </script>
</body>
</html>